<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rental Rando Redux Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
	:root {
	  --bg: #0d0f16;
	  --panel: #151824;
	  --panel-alt: #181b2a;
	  --border: #2c3144;
	  --border-soft: #222636;
	  --accent: #4fd1c5;
	  --accent-soft: rgba(79, 209, 197, 0.15);
	  --text: #e7ecff;
	  --muted: #9aa3c6;
	  --danger: #ff5c5c;
	  --danger-soft: rgba(255, 92, 92, 0.16);
	  --gold: #ffd86b;
	  --gold-soft: rgba(255, 216, 107, 0.3);
	}

	* {
	  box-sizing: border-box;
	}

	body {
	  margin: 0;
	  padding: 0;
	  background: radial-gradient(circle at top, #151824 0, #050612 60%);
	  color: var(--text);
	  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
	  font-size: 12px;
	}

	#app {
	  width: 600px;
	  max-width: 600px;
	  margin: 0 auto;
	  padding: 8px;
	}

	header {
	  text-align: center;
	  margin-bottom: 8px;
	}

	header h1 {
	  font-size: 18px;
	  margin: 0 0 4px;
	  letter-spacing: 0.08em;
	  text-transform: uppercase;
	  color: var(--accent);
	}

	header .subtitle {
	  font-size: 10px;
	  color: var(--muted);
	  text-transform: uppercase;
	  letter-spacing: 0.12em;
	}

	.section {
	  background: linear-gradient(145deg, var(--panel), var(--panel-alt));
	  border-radius: 10px;
	  border: 1px solid var(--border);
	  padding: 8px;
	  margin-bottom: 10px;
	  box-shadow:
		0 0 0 1px rgba(0,0,0,0.5),
		0 10px 20px rgba(0, 0, 0, 0.35);
	}

	.section-header {
	  display: flex;
	  align-items: center;
	  justify-content: space-between;
	  margin-bottom: 6px;
	  gap: 6px;
	}

	.section-header h2 {
	  font-size: 13px;
	  margin: 0;
	  text-transform: uppercase;
	  letter-spacing: 0.08em;
	  color: var(--muted);
	}

	.section-note {
	  margin: 6px 0 0;
	  font-size: 10px;
	  color: var(--muted);
	}

	.subsection {
	  border-radius: 8px;
	  border: 1px solid var(--border-soft);
	  padding: 6px;
	  margin-top: 6px;
	  background: rgba(5, 6, 18, 0.35);
	}

	.subsection-header {
	  display: flex;
	  align-items: center;
	  justify-content: space-between;
	  margin-bottom: 4px;
	  gap: 6px;
	}

	.subsection-header h3 {
	  font-size: 11px;
	  margin: 0;
	  text-transform: uppercase;
	  letter-spacing: 0.08em;
	  color: var(--muted);
	}

	.pokemon-grid {
	  display: grid;
	  gap: 4px;
	}

	.team-grid {
	  grid-template-columns: repeat(3, 1fr);
	}

	.pool-grid {
	  grid-template-columns: repeat(5, 1fr);
	}

	.chat-grid {
	  grid-template-columns: repeat(5, 1fr);
	}

	.random-grid {
	  grid-template-columns: repeat(5, 1fr);
	}

	.player-grid {
	  grid-template-columns: repeat(3, 1fr);
	}

	.pokemon-box {
	  background: radial-gradient(circle at top, #232845 0, #121525 55%, #070814 100%);
	  border-radius: 8px;
	  border: 1px solid var(--border-soft);
	  padding: 4px 3px 5px;
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	  justify-content: flex-start;
	  position: relative;
	  overflow: hidden;
	  min-height: 72px;
	}

	.pokemon-box.tiny {
	  min-height: 64px;
	}

	.pokemon-box.large {
	  min-height: 86px;
	}

	.pokemon-box::before {
	  content: "";
	  position: absolute;
	  inset: 0;
	  background: radial-gradient(circle at top, rgba(79, 209, 197, 0.08), transparent 55%);
	  opacity: 0.6;
	  pointer-events: none;
	}

	.pokemon-box-inner {
	  position: relative;
	  z-index: 1;
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	  width: 100%;
	}

	.sprite-wrap {
	  width: 100%;
	  display: flex;
	  justify-content: center;
	  align-items: center;
	  margin-bottom: 2px;
	}

	.sprite {
	  image-rendering: pixelated;
	  background: #050712;
	  border-radius: 4px;
	  border: 1px solid #101322;
	}

	.pokemon-box.small .sprite {
	  width: 40px;
	  height: 40px;
	}

	.pokemon-box.large .sprite {
	  width: 56px;
	  height: 56px;
	}

	.pokemon-box.tiny .sprite {
	  width: 36px;
	  height: 36px;
	}

	.poke-number {
	  font-size: 10px;
	  color: var(--muted);
	  line-height: 1.1;
	}

	.poke-name {
	  font-size: 10px;
	  margin-top: 1px;
	  color: var(--text);
	  white-space: nowrap;
	  overflow: hidden;
	  text-overflow: clip;
	  max-width: 100%;
	  text-align: center;
	}

	.edit-input-row {
	  margin-top: 2px;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  gap: 2px;
	  width: 100%;
	}

	.edit-input-row label {
	  font-size: 9px;
	  color: var(--muted);
	}

	.poke-input {
	  width: 68px;
	  padding: 1px 2px;
	  font-size: 10px;
	  border-radius: 4px;
	  border: 1px solid var(--border-soft);
	  background: #050712;
	  color: var(--text);
	  text-align: center;
	  outline: none;
	}

	.poke-input:focus {
	  border-color: var(--accent);
	  box-shadow: 0 0 0 1px var(--accent-soft);
	}

	button {
	  border-radius: 999px;
	  border: 1px solid var(--border-soft);
	  background: radial-gradient(circle at top, #272f4f 0, #151827 60%);
	  color: var(--text);
	  font-size: 10px;
	  padding: 4px 10px;
	  cursor: pointer;
	  text-transform: uppercase;
	  letter-spacing: 0.09em;
	  white-space: nowrap;
	  transition: background 120ms ease, border-color 120ms ease, transform 80ms ease, box-shadow 120ms ease;
	  box-shadow: 0 1px 3px rgba(0,0,0,0.6);
	}

	button:hover {
	  background: radial-gradient(circle at top, #2f3a65 0, #181c30 60%);
	  border-color: var(--accent);
	  box-shadow: 0 0 0 1px var(--accent-soft), 0 4px 10px rgba(0,0,0,0.6);
	  transform: translateY(-1px);
	}

	button:active {
	  transform: translateY(0);
	  box-shadow: 0 1px 4px rgba(0,0,0,0.7);
	}

	button:disabled,
	button:disabled:hover {
	  opacity: 0.4;
	  cursor: default;
	  transform: none;
	  background: #101322;
	  border-color: var(--border-soft);
	  box-shadow: 0 1px 3px rgba(0,0,0,0.4);
	}

	.button-secondary {
	  background: #101322;
	}

	.button-danger {
	  border-color: var(--danger);
	  background: radial-gradient(circle at top, #3f1820 0, #221018 70%);
	}

	.button-danger:hover {
	  box-shadow: 0 0 0 1px var(--danger-soft), 0 4px 10px rgba(0,0,0,0.6);
	}

	/* Fainted overlay */
	.pokemon-box.fainted .sprite {
	  opacity: 0.3;
	  filter: grayscale(100%);
	}

	.pokemon-box.fainted::after {
	  content: "✕";
	  position: absolute;
	  inset: 0;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  font-size: 32px;
	  color: rgba(255, 100, 100, 0.9);
	  pointer-events: none;
	  text-shadow: 0 0 4px #000;
	  z-index: 2;
	}

	.pokemon-box.tiny.fainted::after {
	  font-size: 28px;
	}

	/* Duplicate highlighting */
	.pokemon-box.duplicate {
	  border-color: var(--danger);
	  box-shadow:
		0 0 0 1px var(--danger-soft),
		0 0 12px var(--danger-soft);
	  background: radial-gradient(circle at top, #3a1820 0, #171018 60%);
	}

	.pokemon-box.duplicate .poke-name {
	  color: var(--danger);
	}

	/* Special chat Pokémon styling */
	.special-chat {
	  border-color: var(--gold);
	  box-shadow:
		0 0 0 1px var(--gold-soft),
		0 0 16px rgba(255, 216, 107, 0.18);
	  background: radial-gradient(circle at top, #403018 0, #221b0e 55%, #0b0702 100%);
	}

	.special-chat .poke-name {
	  color: #ffe8a3;
	}

	.special-tag {
	  font-size: 9px;
	  margin-top: 1px;
	  color: var(--gold);
	  text-transform: uppercase;
	  letter-spacing: 0.08em;
	}

	/* Small info row under sections */
	.info-row {
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  gap: 4px;
	  margin-top: 4px;
	  font-size: 9px;
	  color: var(--muted);
	}

	.pill {
	  border-radius: 999px;
	  padding: 2px 6px;
	  background: rgba(10, 14, 28, 0.9);
	  border: 1px solid var(--border-soft);
	}
  </style>
</head>
<body>
<div id="app">
  <header>
	<h1>Rental Rando Redux</h1>
	<div class="subtitle">Pokemon Tracker Widget</div>
  </header>

  <!-- SECTION 1: CURRENT TEAM -->
  <section id="section-team" class="section">
	<div class="section-header">
	  <h2>Current Team (6)</h2>
	  <button id="reroll-team-btn" disabled>Generate Team</button>
	</div>
	<div id="team-grid" class="pokemon-grid team-grid"></div>
	<div class="info-row">
	  <span>Click a Pokémon here to toggle fainted status.</span>
	  <span class="pill">Team uses only alive pool Pokémon. Fill pool first.</span>
	</div>
  </section>

  <!-- SECTION 2: CURRENT ATTEMPT POKEMON POOL -->
  <section id="section-pool" class="section">
	<div class="section-header">
	  <h2>Current Attempt Pool</h2>
	  <button id="revive-random-btn" class="button-secondary">Revive Random Fainted</button>
	</div>
	<div id="pool-grid" class="pokemon-grid pool-grid"></div>
	<p class="section-note">
	  Grid shows all pool Pokémon (Chat Picks, Random Pool, Player Picks) plus a special fixed #083 in the bottom-right.
	  Click any box to faint / revive that Pokémon.
	</p>
  </section>

  <!-- SECTION 3: POOL SETUP -->
  <section id="section-setup" class="section">
	<div class="section-header">
	  <h2>Pokémon Pool Setup</h2>
	</div>

	<!-- Chat Picks -->
	<div class="subsection">
	  <div class="subsection-header">
		<h3>Chat Picks (5 + Special)</h3>
		<button id="clear-chat-btn" class="button-secondary">Clear Chat Picks</button>
	  </div>
	  <div id="chat-grid" class="pokemon-grid chat-grid"></div>
	</div>

	<!-- Random Pool -->
	<div class="subsection">
	  <div class="subsection-header">
		<h3>Random Pool (18)</h3>
		<button id="regen-random-btn">Re-generate 18 Random</button>
	  </div>
	  <div id="random-grid" class="pokemon-grid random-grid"></div>
	  <p class="section-note">
		Random pool is drawn from #001–151 with no duplicates and never repeats Chat Picks or the special #083.
	  </p>
	</div>

	<!-- Player Picks -->
	<div class="subsection">
	  <div class="subsection-header">
		<h3>Player Picks (6)</h3>
		<button id="clear-player-btn" class="button-secondary">Clear Player Picks</button>
	  </div>
	  <div id="player-grid" class="pokemon-grid player-grid"></div>
	</div>

	<p class="section-note">
	  Any slot highlighted in red is a duplicate across Chat Picks, Random Pool, or Player Picks (including #083).
	  Once all 30 unique Pokémon are set, you can generate a team.
	</p>
  </section>
</div>

<script>
  const MAX_POKEMON = 151;
  const SPECIAL_FIXED = 83; // Special 6th chat-selected Pokémon

  // Index 0 is "None" / empty placeholder
  const pokemonNames = [
	"None",
	"Bulbasaur", "Ivysaur", "Venusaur",
	"Charmander", "Charmeleon", "Charizard",
	"Squirtle", "Wartortle", "Blastoise",
	"Caterpie", "Metapod", "Butterfree",
	"Weedle", "Kakuna", "Beedrill",
	"Pidgey", "Pidgeotto", "Pidgeot",
	"Rattata", "Raticate",
	"Spearow", "Fearow",
	"Ekans", "Arbok",
	"Pikachu", "Raichu",
	"Sandshrew", "Sandslash",
	"Nidoran\u2640", "Nidorina", "Nidoqueen",
	"Nidoran\u2642", "Nidorino", "Nidoking",
	"Clefairy", "Clefable",
	"Vulpix", "Ninetales",
	"Jigglypuff", "Wigglytuff",
	"Zubat", "Golbat",
	"Oddish", "Gloom", "Vileplume",
	"Paras", "Parasect",
	"Venonat", "Venomoth",
	"Diglett", "Dugtrio",
	"Meowth", "Persian",
	"Psyduck", "Golduck",
	"Mankey", "Primeape",
	"Growlithe", "Arcanine",
	"Poliwag", "Poliwhirl", "Poliwrath",
	"Abra", "Kadabra", "Alakazam",
	"Machop", "Machoke", "Machamp",
	"Bellsprout", "Weepinbell", "Victreebel",
	"Tentacool", "Tentacruel",
	"Geodude", "Graveler", "Golem",
	"Ponyta", "Rapidash",
	"Slowpoke", "Slowbro",
	"Magnemite", "Magneton",
	"Farfetch'd",
	"Doduo", "Dodrio",
	"Seel", "Dewgong",
	"Grimer", "Muk",
	"Shellder", "Cloyster",
	"Gastly", "Haunter", "Gengar",
	"Onix",
	"Drowzee", "Hypno",
	"Krabby", "Kingler",
	"Voltorb", "Electrode",
	"Exeggcute", "Exeggutor",
	"Cubone", "Marowak",
	"Hitmonlee", "Hitmonchan",
	"Lickitung",
	"Koffing", "Weezing",
	"Rhyhorn", "Rhydon",
	"Chansey",
	"Tangela",
	"Kangaskhan",
	"Horsea", "Seadra",
	"Goldeen", "Seaking",
	"Staryu", "Starmie",
	"Mr. Mime",
	"Scyther",
	"Jynx",
	"Electabuzz",
	"Magmar",
	"Pinsir",
	"Tauros",
	"Magikarp", "Gyarados",
	"Lapras",
	"Ditto",
	"Eevee", "Vaporeon", "Jolteon", "Flareon",
	"Porygon",
	"Omanyte", "Omastar",
	"Kabuto", "Kabutops",
	"Aerodactyl",
	"Snorlax",
	"Articuno", "Zapdos", "Moltres",
	"Dratini", "Dragonair", "Dragonite",
	"Mewtwo", "Mew"
  ];

  // Data state
  let chatPicked = Array(5).fill(0);
  let randomPool = Array(18).fill(0);
  let playerPicked = Array(6).fill(0);
  let currentTeam = Array(6).fill(0);
  let faintedMap = {}; // pokemonNumber -> boolean

  // DOM references
  const chatSlotElements = [];
  const playerSlotElements = [];
  let randomSlotElements = [];
  let specialChatElement = null;

  // ---------- Utility ----------

  function createSpriteSrc(num) {
	const n = (Number(num) > 0 && Number(num) <= MAX_POKEMON) ? Number(num) : 0;
	return `images/pokemon/${n}.png`;
  }

  function clampPokemonNumber(value) {
	const num = parseInt(value, 10);
	if (isNaN(num) || num < 1 || num > MAX_POKEMON) return 0;
	return num;
  }

  // ---------- Name matching helpers ----------

  function normalizeName(str) {
	return (str || "")
	  .toLowerCase()
	  .replace(/[^a-z0-9]/g, "");
  }

  function levenshtein(a, b) {
	const m = a.length;
	const n = b.length;
	if (m === 0) return n;
	if (n === 0) return m;

	const dp = new Array(n + 1);
	for (let j = 0; j <= n; j++) dp[j] = j;

	for (let i = 1; i <= m; i++) {
	  let prev = dp[0];
	  dp[0] = i;
	  for (let j = 1; j <= n; j++) {
		const temp = dp[j];
		if (a[i - 1] === b[j - 1]) {
		  dp[j] = prev;
		} else {
		  dp[j] = Math.min(prev + 1, dp[j] + 1, dp[j - 1] + 1);
		}
		prev = temp;
	  }
	}
	return dp[n];
  }

  function findClosestPokemonByName(input) {
	const q = normalizeName(input);
	if (!q) return 0;

	// 1) Exact normalized match
	for (let i = 1; i <= MAX_POKEMON; i++) {
	  const norm = normalizeName(pokemonNames[i] || "");
	  if (norm === q) return i;
	}

	// 2) Prefix matches (choose shortest name)
	const prefixMatches = [];
	for (let i = 1; i <= MAX_POKEMON; i++) {
	  const norm = normalizeName(pokemonNames[i] || "");
	  if (norm.startsWith(q)) {
		prefixMatches.push({ index: i, len: norm.length });
	  }
	}
	if (prefixMatches.length > 0) {
	  prefixMatches.sort((a, b) => a.len - b.len);
	  return prefixMatches[0].index;
	}

	// 3) Substring matches (fallback before fuzzy)
	const substringMatches = [];
	for (let i = 1; i <= MAX_POKEMON; i++) {
	  const norm = normalizeName(pokemonNames[i] || "");
	  if (norm.includes(q)) {
		substringMatches.push({ index: i, len: norm.length });
	  }
	}
	if (substringMatches.length > 0) {
	  substringMatches.sort((a, b) => a.len - b.len);
	  return substringMatches[0].index;
	}

	// 4) Fuzzy match (Levenshtein) with threshold
	let bestIndex = 0;
	let bestScore = Infinity;
	for (let i = 1; i <= MAX_POKEMON; i++) {
	  const norm = normalizeName(pokemonNames[i] || "");
	  if (!norm) continue;
	  const d = levenshtein(q, norm);
	  if (d < bestScore) {
		bestScore = d;
		bestIndex = i;
	  }
	}

	const threshold = Math.max(1, Math.floor(q.length / 2));
	if (bestScore <= threshold) return bestIndex;
	return 0;
  }

  function parsePokemonInput(value) {
	const raw = (value || "").trim();
	if (!raw) return 0;

	// Numeric only?
	if (/^\d+$/.test(raw)) {
	  return clampPokemonNumber(raw);
	}

	// Name lookup
	return findClosestPokemonByName(raw);
  }

  // ---------- Slot helpers ----------

  function setSectionNumber(section, index, num) {
	if (section === "chat") {
	  chatPicked[index] = num;
	} else if (section === "player") {
	  playerPicked[index] = num;
	}
  }

  function updateBoxVisuals(num, imgEl, nameEl) {
	if (!num) {
	  imgEl.src = createSpriteSrc(0);
	  nameEl.textContent = "";
	} else {
	  imgEl.src = createSpriteSrc(num);
	  nameEl.textContent = pokemonNames[num] || "";
	}
  }

  // ---------- UI creation ----------

  function createEditSlot(section, index) {
	const box = document.createElement("div");
	box.className = "pokemon-box small edit-slot " + section + "-slot";

	const inner = document.createElement("div");
	inner.className = "pokemon-box-inner";

	const spriteWrap = document.createElement("div");
	spriteWrap.className = "sprite-wrap";

	const img = document.createElement("img");
	img.className = "sprite";
	img.src = createSpriteSrc(0);
	img.alt = "Empty";

	spriteWrap.appendChild(img);

	const nameDiv = document.createElement("div");
	nameDiv.className = "poke-name";
	nameDiv.textContent = "";

	// Number row
	const numRow = document.createElement("div");
	numRow.className = "edit-input-row";

	const numLabel = document.createElement("label");
	numLabel.textContent = "#";

	const numInput = document.createElement("input");
	numInput.type = "number";
	numInput.min = "1";
	numInput.max = String(MAX_POKEMON);
	numInput.inputMode = "numeric";
	numInput.className = "poke-input poke-input-number";
	numInput.placeholder = "no.";
	numInput.dataset.section = section;
	numInput.dataset.index = String(index);

	numLabel.appendChild(numInput);
	numRow.appendChild(numLabel);

	// Name row
	const nameRow = document.createElement("div");
	nameRow.className = "edit-input-row";

	const nameLabel = document.createElement("label");
	nameLabel.textContent = "Nm";

	const nameInput = document.createElement("input");
	nameInput.type = "text";
	nameInput.inputMode = "text";
	nameInput.className = "poke-input poke-input-name";
	nameInput.placeholder = "name";
	nameInput.dataset.section = section;
	nameInput.dataset.index = String(index);

	nameLabel.appendChild(nameInput);
	nameRow.appendChild(nameLabel);

	// Event handlers
	numInput.addEventListener("input", () => {
	  handleNumberChange(section, index, numInput, nameInput, img, nameDiv);
	});

	nameInput.addEventListener("input", () => {
	  handleNameChange(section, index, numInput, nameInput, img, nameDiv);
	});

	inner.appendChild(spriteWrap);
	inner.appendChild(nameDiv);
	inner.appendChild(numRow);
	inner.appendChild(nameRow);
	box.appendChild(inner);

	if (section === "chat") {
	  chatSlotElements[index] = box;
	} else if (section === "player") {
	  playerSlotElements[index] = box;
	}

	return box;
  }

  function createSpecialChatDisplay() {
	const box = document.createElement("div");
	box.className = "pokemon-box small special-chat";

	const inner = document.createElement("div");
	inner.className = "pokemon-box-inner";

	const spriteWrap = document.createElement("div");
	spriteWrap.className = "sprite-wrap";

	const img = document.createElement("img");
	img.className = "sprite";
	img.src = createSpriteSrc(SPECIAL_FIXED);
	img.alt = pokemonNames[SPECIAL_FIXED] || "";

	spriteWrap.appendChild(img);

	const numberDiv = document.createElement("div");
	numberDiv.className = "poke-number";
	numberDiv.textContent = `#${String(SPECIAL_FIXED).padStart(3, "0")}`;

	const nameDiv = document.createElement("div");
	nameDiv.className = "poke-name";
	nameDiv.textContent = pokemonNames[SPECIAL_FIXED] || "";

	const tagDiv = document.createElement("div");
	tagDiv.className = "special-tag";
	tagDiv.textContent = "Special Chat Pick";

	inner.appendChild(spriteWrap);
	inner.appendChild(numberDiv);
	inner.appendChild(nameDiv);
	inner.appendChild(tagDiv);
	box.appendChild(inner);

	return box;
  }

  function handleNumberChange(section, index, numInput, nameInput, imgEl, nameEl) {
	const raw = (numInput.value || "").trim();
	const num = clampPokemonNumber(raw);

	setSectionNumber(section, index, num);
	updateBoxVisuals(num, imgEl, nameEl);

	if (num > 0) {
	  nameInput.value = pokemonNames[num] || "";
	} else {
	  nameInput.value = "";
	}

	afterPoolDataChanged();
  }

  function handleNameChange(section, index, numInput, nameInput, imgEl, nameEl) {
	const raw = (nameInput.value || "").trim();
	const num = parsePokemonInput(raw); // supports both "pikachu" and "25"

	setSectionNumber(section, index, num);
	updateBoxVisuals(num, imgEl, nameEl);

	if (num > 0) {
	  numInput.value = String(num);
	} else {
	  numInput.value = "";
	}

	// Do NOT overwrite nameInput.value so user can keep typing/refining
	afterPoolDataChanged();
  }

  function buildEditGrids() {
	const chatGrid = document.getElementById("chat-grid");
	const playerGrid = document.getElementById("player-grid");

	for (let i = 0; i < chatPicked.length; i++) {
	  const slot = createEditSlot("chat", i);
	  chatGrid.appendChild(slot);
	}

	// Special fixed chat Pokémon (#083)
	const specialBox = createSpecialChatDisplay();
	chatGrid.appendChild(specialBox);
	specialChatElement = specialBox;

	for (let i = 0; i < playerPicked.length; i++) {
	  const slot = createEditSlot("player", i);
	  playerGrid.appendChild(slot);
	}
  }

  // ---------- Random pool ----------

  function regenerateRandomPool() {
	const forbidden = new Set(chatPicked.filter(n => n > 0));
	// Special fixed Pokémon can never appear in random pool
	forbidden.add(SPECIAL_FIXED);

	const used = new Set(forbidden);
	const chosen = [];

	while (chosen.length < randomPool.length && used.size < MAX_POKEMON) {
	  const rand = 1 + Math.floor(Math.random() * MAX_POKEMON);
	  if (!used.has(rand)) {
		used.add(rand);
		chosen.push(rand);
	  }
	}
	randomPool = chosen;
	renderRandomGrid();
	afterPoolDataChanged();
  }

  function renderRandomGrid() {
	const container = document.getElementById("random-grid");
	container.innerHTML = "";
	randomSlotElements = [];

	randomPool.forEach((num, idx) => {
	  const box = document.createElement("div");
	  box.className = "pokemon-box tiny";

	  const inner = document.createElement("div");
	  inner.className = "pokemon-box-inner";

	  const spriteWrap = document.createElement("div");
	  spriteWrap.className = "sprite-wrap";

	  const img = document.createElement("img");
	  img.className = "sprite";
	  img.src = createSpriteSrc(num);
	  img.alt = num ? pokemonNames[num] || "" : "Empty";

	  spriteWrap.appendChild(img);

	  const numberDiv = document.createElement("div");
	  numberDiv.className = "poke-number";
	  numberDiv.textContent = num ? `#${String(num).padStart(3, "0")}` : "";

	  const nameDiv = document.createElement("div");
	  nameDiv.className = "poke-name";
	  nameDiv.textContent = num ? pokemonNames[num] || "" : "";

	  inner.appendChild(spriteWrap);
	  inner.appendChild(numberDiv);
	  inner.appendChild(nameDiv);

	  box.appendChild(inner);
	  container.appendChild(box);

	  randomSlotElements[idx] = box;
	});
  }

  // ---------- Pool + team logic ----------

  function getPoolNumbers(includeSpecial = true) {
	const list = [];
	chatPicked.forEach(n => { if (n > 0) list.push(n); });
	randomPool.forEach(n => { if (n > 0) list.push(n); });
	playerPicked.forEach(n => { if (n > 0) list.push(n); });
	if (includeSpecial && SPECIAL_FIXED > 0) {
	  list.push(SPECIAL_FIXED);
	}
	return list;
  }

  function pruneFainted() {
	const poolSet = new Set(getPoolNumbers(true));
	Object.keys(faintedMap).forEach(key => {
	  const num = Number(key);
	  if (!poolSet.has(num)) {
		delete faintedMap[num];
	  }
	});
  }

  function renderPoolGrid() {
	const container = document.getElementById("pool-grid");
	container.innerHTML = "";

	// 5x6 grid = 30 slots: 29 from selected pool, last one is always special #83
	const poolList = getPoolNumbers(false);
	const totalSlots = 30;

	for (let i = 0; i < totalSlots; i++) {
	  let num = 0;
	  if (i < totalSlots - 1) {
		num = poolList[i] || 0;
	  } else {
		num = SPECIAL_FIXED;
	  }

	  const box = document.createElement("div");
	  box.className = "pokemon-box tiny pool-slot";
	  if (num && faintedMap[num]) {
		box.classList.add("fainted");
	  }
	  box.dataset.num = String(num);

	  const inner = document.createElement("div");
	  inner.className = "pokemon-box-inner";

	  const spriteWrap = document.createElement("div");
	  spriteWrap.className = "sprite-wrap";

	  const img = document.createElement("img");
	  img.className = "sprite";
	  img.src = createSpriteSrc(num);
	  img.alt = num ? pokemonNames[num] || "" : "Empty";

	  spriteWrap.appendChild(img);

	  const numberDiv = document.createElement("div");
	  numberDiv.className = "poke-number";
	  numberDiv.textContent = num ? `#${String(num).padStart(3, "0")}` : "";

	  const nameDiv = document.createElement("div");
	  nameDiv.className = "poke-name";
	  nameDiv.textContent = num ? pokemonNames[num] || "" : "";

	  inner.appendChild(spriteWrap);
	  inner.appendChild(numberDiv);
	  inner.appendChild(nameDiv);
	  box.appendChild(inner);
	  container.appendChild(box);

	  box.addEventListener("click", () => {
		if (!num) return;
		faintedMap[num] = !faintedMap[num];
		renderPoolGrid();
		renderTeam();
	  });
	}
  }

  function getAvailablePokemonUnique() {
	const poolList = getPoolNumbers(true);
	const seen = new Set();
	const available = [];

	for (const num of poolList) {
	  if (num > 0 && !faintedMap[num] && !seen.has(num)) {
		seen.add(num);
		available.push(num);
	  }
	}
	return available;
  }

  function shuffleArray(arr) {
	for (let i = arr.length - 1; i > 0; i--) {
	  const j = Math.floor(Math.random() * (i + 1));
	  [arr[i], arr[j]] = [arr[j], arr[i]];
	}
  }

  function rerollTeam() {
	const available = getAvailablePokemonUnique();
	shuffleArray(available);
	for (let i = 0; i < currentTeam.length; i++) {
	  currentTeam[i] = available[i] || 0;
	}
	renderTeam();
  }

  function ensureTeamValid() {
	const poolSet = new Set(getPoolNumbers(true));
	for (let i = 0; i < currentTeam.length; i++) {
	  const num = currentTeam[i];
	  if (num && !poolSet.has(num)) {
		currentTeam[i] = 0;
	  }
	}
  }

  function renderTeam() {
	const container = document.getElementById("team-grid");
	container.innerHTML = "";

	currentTeam.forEach((num) => {
	  const box = document.createElement("div");
	  box.className = "pokemon-box large team-slot";
	  if (num && faintedMap[num]) {
		box.classList.add("fainted");
	  }
	  box.dataset.num = String(num);

	  const inner = document.createElement("div");
	  inner.className = "pokemon-box-inner";

	  const spriteWrap = document.createElement("div");
	  spriteWrap.className = "sprite-wrap";

	  const img = document.createElement("img");
	  img.className = "sprite";
	  img.src = createSpriteSrc(num);
	  img.alt = num ? pokemonNames[num] || "" : "Empty";

	  spriteWrap.appendChild(img);

	  const numberDiv = document.createElement("div");
	  numberDiv.className = "poke-number";
	  numberDiv.textContent = num ? `#${String(num).padStart(3, "0")}` : "";

	  const nameDiv = document.createElement("div");
	  nameDiv.className = "poke-name";
	  nameDiv.textContent = num ? pokemonNames[num] || "" : "";

	  inner.appendChild(spriteWrap);
	  inner.appendChild(numberDiv);
	  inner.appendChild(nameDiv);
	  box.appendChild(inner);
	  container.appendChild(box);

	  box.addEventListener("click", () => {
		if (!num) return;
		faintedMap[num] = !faintedMap[num];
		renderTeam();
		renderPoolGrid();
	  });
	});
  }

  function reviveRandomFainted() {
	const fainted = Object.keys(faintedMap)
	  .map(n => Number(n))
	  .filter(n => faintedMap[n] && n > 0);

	if (fainted.length === 0) return;

	const choice = fainted[Math.floor(Math.random() * fainted.length)];
	faintedMap[choice] = false;
	renderPoolGrid();
	renderTeam();
  }

  function validateDuplicates() {
	const counts = {};
	const entries = [];

	const addEntry = (num, elem) => {
	  if (!num || !elem) return;
	  counts[num] = (counts[num] || 0) + 1;
	  entries.push({ num, elem });
	};

	chatPicked.forEach((num, idx) => {
	  addEntry(num, chatSlotElements[idx]);
	});

	randomPool.forEach((num, idx) => {
	  addEntry(num, randomSlotElements[idx]);
	});

	playerPicked.forEach((num, idx) => {
	  addEntry(num, playerSlotElements[idx]);
	});

	// Include special fixed Pokémon as part of duplicate checking
	addEntry(SPECIAL_FIXED, specialChatElement);

	const allElems = [
	  ...chatSlotElements,
	  ...randomSlotElements,
	  ...playerSlotElements,
	  specialChatElement
	].filter(Boolean);

	allElems.forEach(el => el.classList.remove("duplicate"));

	entries.forEach(({ num, elem }) => {
	  if (counts[num] > 1) {
		elem.classList.add("duplicate");
	  }
	});
  }

  function isPoolComplete() {
	// All slots filled (5 chat, 18 random, 6 player)
	if (chatPicked.some(n => n === 0)) return false;
	if (playerPicked.some(n => n === 0)) return false;
	if (randomPool.some(n => n === 0)) return false;

	// Check for duplicates, including special fixed Pokémon
	const counts = {};
	const add = (num) => {
	  if (num > 0) counts[num] = (counts[num] || 0) + 1;
	};

	chatPicked.forEach(add);
	randomPool.forEach(add);
	playerPicked.forEach(add);
	add(SPECIAL_FIXED);

	return Object.values(counts).every(c => c === 1);
  }

  function updateTeamButtonState() {
	const btn = document.getElementById("reroll-team-btn");
	if (!btn) return;
	btn.disabled = !isPoolComplete();
  }

  function afterPoolDataChanged() {
	pruneFainted();
	renderPoolGrid();
	validateDuplicates();
	ensureTeamValid();
	renderTeam();
	updateTeamButtonState();
  }

  function clearChatPicks() {
	chatPicked = Array(5).fill(0);
	chatSlotElements.forEach((box) => {
	  const img = box.querySelector(".sprite");
	  const nameDiv = box.querySelector(".poke-name");
	  const numInput = box.querySelector(".poke-input-number");
	  const nameInput = box.querySelector(".poke-input-name");
	  img.src = createSpriteSrc(0);
	  nameDiv.textContent = "";
	  if (numInput) numInput.value = "";
	  if (nameInput) nameInput.value = "";
	});
	afterPoolDataChanged();
  }

  function clearPlayerPicks() {
	playerPicked = Array(6).fill(0);
	playerSlotElements.forEach((box) => {
	  const img = box.querySelector(".sprite");
	  const nameDiv = box.querySelector(".poke-name");
	  const numInput = box.querySelector(".poke-input-number");
	  const nameInput = box.querySelector(".poke-input-name");
	  img.src = createSpriteSrc(0);
	  nameDiv.textContent = "";
	  if (numInput) numInput.value = "";
	  if (nameInput) nameInput.value = "";
	});
	afterPoolDataChanged();
  }

  // Init
  (function init() {
	buildEditGrids();        // Edit boxes + special chat
	renderRandomGrid();      // Random pool starts empty (0.png)
	afterPoolDataChanged();  // Renders pool (with #83 bottom-right) and empty team

	document.getElementById("reroll-team-btn")
	  .addEventListener("click", () => {
		if (!isPoolComplete()) return;
		rerollTeam();
	  });

	document.getElementById("revive-random-btn")
	  .addEventListener("click", reviveRandomFainted);

	document.getElementById("regen-random-btn")
	  .addEventListener("click", regenerateRandomPool);

	document.getElementById("clear-chat-btn")
	  .addEventListener("click", clearChatPicks);

	document.getElementById("clear-player-btn")
	  .addEventListener("click", clearPlayerPicks);
  })();
</script>
</body>
</html>
